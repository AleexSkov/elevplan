
@page "/opretuser"
@using System.Text.Json.Serialization
@using Core.Models
@inject HttpClient Http
@inject NavigationManager Nav

<div class="form-wrapper">
    <div class="form-container">
        <h3>Opret bruger</h3>

        <EditForm Model="newUser" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label>Email</label>
                <InputText @bind-Value="newUser.Email" class="form-control" />
            </div>

            <div class="mb-3">
                <label>Navn</label>
                <InputText @bind-Value="newUser.Name" class="form-control" />
            </div>

            <div class="mb-3">
                <label>Rolle</label>
                <InputSelect @bind-Value="newUser.Role" class="form-control">
                    <option value="">Vælg rolle</option>
                    <option value="Elev">Elev</option>
                    <option value="Admin">Admin</option>
                </InputSelect>
            </div>

            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" @onclick="Tilbage">Annullér</button>
                <button type="submit" class="btn btn-primary">Opret bruger</button>
            </div>
        </EditForm>

        @if (!string.IsNullOrEmpty(generatedPassword))
        {
            <div class="generated-password mt-4">
                <h5>Genereret adgangskode:</h5>
                <InputText @bind-Value="generatedPassword" class="form-control" readonly />
            </div>
        }

        @if (!string.IsNullOrEmpty(generatedElevId))
        {
            <div class="generated-elevid mt-3">
                <h5>Elev ID:</h5>
                <InputText @bind-Value="generatedElevId" class="form-control" readonly />
            </div>
        }

        @if (!string.IsNullOrEmpty(message))
        {
            <p class="alert-info mt-3">@message</p>
        }
    </div>
</div>

@code {
    private AppUser newUser = new();
    private string? generatedPassword;
    private string? generatedElevId;
    private string? message;

    private record RegisterResponse(
        string Message,
        string Password,
        string? ElevId);

    private async Task HandleRegister()
    {
        generatedPassword = GenerateRandomPassword();
        newUser.PasswordHash = generatedPassword;
        message = null;
        generatedElevId = null;

        var response = await Http.PostAsJsonAsync("api/auth/register", newUser);
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<RegisterResponse>();
            if (result is not null)
            {
                message = result.Message;
                generatedPassword = result.Password;
                generatedElevId = result.ElevId;
            }
            // Reset form model
            newUser = new();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            message = "Fejl: " + error;
            generatedPassword = null;
        }
    }

    private void Tilbage() => Nav.NavigateTo("/dashboard");

    private string GenerateRandomPassword()
    {
        const string chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
        var random = new Random();
        return new string(Enumerable.Range(0, 10)
            .Select(_ => chars[random.Next(chars.Length)])
            .ToArray());
    }
}
