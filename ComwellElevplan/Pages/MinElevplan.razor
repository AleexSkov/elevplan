@page "/min-elevplan"                   
<!-- Rute til siden -->

@using Core.Models                      
<!-- Gør model-klasser som Elevplan og Praktikperiode tilgængelige -->
@using System.Net.Http.Json
@inject HttpClient Http                 
<!-- Bruges til at hente elevens data fra API'et -->
@inject IJSRuntime JS                   
<!-- Bruges til at læse elevId fra localStorage -->

<h3>Min Elevplan</h3>

@if (plan is null)
{
    <p>Indlæser din elevplan…</p>        <!-- Ventebesked -->
}
else
{
    <!-- Info om elev og plan -->
    <div class="mb-3">
        <h4>@plan.ElevNavn</h4>
        <p><strong>Skole:</strong> @plan.Skole</p>
        <p><strong>Aftaleform:</strong> @plan.Aftaleform</p>
    </div>

    <!-- Dropdown til at vælge praktikperiode -->
    <div class="mb-3">
        <label>Vælg periode:</label>
        <select @onchange="OnPeriodChanged" class="form-select">
            @foreach (var p in plan.Praktikperioder)
            {
                <option value="@p.PeriodeNummer">
                    Periode @p.PeriodeNummer (@p.VarighedUger uger)
                </option>
            }
        </select>
    </div>

    @if (selectedPeriod != null)
    {
        <!-- Liste over delmål i den valgte periode -->
        <h5>Delmål for Periode @selectedPeriod.PeriodeNummer</h5>
        <ul class="list-group">
            @foreach (var delmaal in selectedPeriod.Opgaver)
            {
                <li class="list-group-item d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" checked="@delmaal.Gennemført" disabled />
                    <div class="flex-grow-1">
                        <strong>@delmaal.Kategori:</strong> @delmaal.Beskrivelse<br />
                        <small>Ansvarlig: @delmaal.Ansvarlig, Initiator: @delmaal.Initiator, Deadline: @delmaal.Tidslinje</small>
                    </div>
                </li>
            }
        </ul>
    }
}

@code {
    private Elevplan? plan;                              // Hele elevens praktikplan
    private Praktikperiode? selectedPeriod;              // Den valgte praktikperiode

    /// <summary>
    /// Henter elevens elevplan ud fra id, som er gemt i localStorage.
    /// Viser automatisk første periode som valgt.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        var elevId = await JS.InvokeAsync<string>("localStorage.getItem", "elevId");
        if (!string.IsNullOrEmpty(elevId))
        {
            plan = await Http.GetFromJsonAsync<Elevplan>($"/api/elevplaner/{elevId}");
            selectedPeriod = plan?.Praktikperioder.FirstOrDefault();
        }
    }

    /// <summary>
    /// Skifter den viste periode ud fra brugerens valg i dropdown.
    /// </summary>
    private void OnPeriodChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var num))
        {
            selectedPeriod = plan?.Praktikperioder.FirstOrDefault(p => p.PeriodeNummer == num);
        }
    }
}
