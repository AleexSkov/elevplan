@page "/min-elevplan"

@using System
@using System.Linq
@using System.Collections.Generic
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<h3>Min Elevplan</h3>

@if (plan is null)
{
    <p>Indlæser din elevplan…</p>
}
else
{
    <div class="mb-3">
        <h4>@plan.ElevNavn</h4>
        <p><strong>Skole:</strong> @plan.Skole</p>
        <p><strong>Aftaleform:</strong> @plan.Aftaleform</p>
    </div>

    <div class="mb-3">
        <label>Vælg periode:</label>
        <select @onchange="OnPeriodChanged" class="form-select">
            @foreach (var p in plan.Praktikperioder)
            {
                <option value="@p.PeriodeNummer">
                    Periode @p.PeriodeNummer (@p.VarighedUger uger)
                </option>
            }
        </select>
    </div>

    @if (selectedPeriod != null)
    {
        <h5>Opgaver for Periode @selectedPeriod.PeriodeNummer</h5>
        <ul class="list-group">
            @foreach (var op in selectedPeriod.Opgaver)
            {
                <li class="list-group-item d-flex align-items-center">
                    <input type="checkbox"
                           class="form-check-input me-2"
                           checked="@op.Gennemført"
                           @onchange="() => Toggle(op)" />
                    <div>
                        <strong>@op.Kategori:</strong> @op.Beskrivelse
                    </div>
                </li>
            }
        </ul>
    }
}

@code {
    // Peg direkte på Core-modellen Elevplan
    private Core.Models.Elevplan?                  plan;
    private Core.Models.Praktikperiode?            selectedPeriod;

    protected override async Task OnInitializedAsync()
    {
        var elevId = await JS.InvokeAsync<string>("localStorage.getItem", "elevId");
        if (!string.IsNullOrEmpty(elevId))
        {
            // Hent som Core.Models.Elevplan
            plan = await Http.GetFromJsonAsync<Core.Models.Elevplan>($"api/elevplan/{elevId}");
            selectedPeriod = plan?.Praktikperioder.FirstOrDefault();
        }
    }

    private void OnPeriodChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var num))
        {
            selectedPeriod = plan?.Praktikperioder
                .FirstOrDefault(p => p.PeriodeNummer == num);
        }
    }

    private async Task Toggle(Core.Models.Opgave op)
    {
        op.Gennemført = !op.Gennemført;
        await Http.PostAsJsonAsync(
            $"api/elevplan/{plan!.ElevId}/opgave",
            new
            {
                PeriodeNummer = selectedPeriod!.PeriodeNummer,
                Kategori      = op.Kategori,
                Beskrivelse   = op.Beskrivelse,
                Gennemført    = op.Gennemført
            });
    }
}
